<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Financial Overview</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header .logo {
            max-height: 80px;
            margin-bottom: 20px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #4ECDC4;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #4ECDC4;
            background: #E8F8F5;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #26D0CE 0%, #1A2980 100%);
        }

        .item-list {
            margin-top: 20px;
        }

        .item {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .item-details {
            flex: 1;
        }

        .item-amount {
            font-weight: bold;
            color: #27ae60;
            font-size: 1.2em;
            min-width: 80px;
            text-align: right;
        }

        .item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary {
            background: linear-gradient(135deg, #FF8E53 0%, #FF6B6B 100%);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }

        .summary h2 {
            color: white;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .summary-item h3 {
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .summary-item .amount {
            font-size: 1.5em;
            font-weight: bold;
        }

        .member-breakdown {
            margin-top: 20px;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .toggle-section {
            margin-bottom: 20px;
        }

        .toggle-section input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            border-bottom-color: #4ECDC4;
            color: #4ECDC4;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .col {
            flex: 1;
        }

        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .checkbox-group {
                flex-direction: column;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Spull Band Logo" class="logo">
            <h1>Band Financial Overview</h1>
            <p>Monthly financial tracking for the band</p>
        </div>

        <div class="content">
            <!-- Settings Section -->
            <div class="section">
                <h2>Settings</h2>
                
                <div class="row">
                    <div class="col">
                        <div class="toggle-section">
                            <label>
                                <input type="checkbox" id="socialWelfare" checked> 
                                Social welfare (all gigs pay the same)
                            </label>
                            <small style="color: #7f8c8d; margin-left: 25px; display: block; margin-top: 5px;">
                                When enabled, treats all gigs as paying the average amount for fair distribution
                            </small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="toggle-section">
                            <label>
                                <input type="checkbox" id="includeBandpotInExpenses" checked> 
                                Include Bandpot in expense deductions
                            </label>
                            <small style="color: #7f8c8d; margin-left: 25px; display: block; margin-top: 5px;">
                                When enabled, Bandpot participates in expense splitting like other members
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Income Section -->
            <div class="section">
                <h2>Income (Gigs)</h2>

                <div class="form-group">
                    <label>Gig Name</label>
                    <input type="text" id="gigName" placeholder="Enter gig name">
                </div>

                <div class="form-group">
                    <label>Amount (â‚¬)</label>
                    <input type="number" id="gigAmount" placeholder="0.00" step="0.01">
                </div>

                <div class="form-group">
                    <label>Participants</label>
                    <div class="checkbox-group" id="gigParticipants">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <button class="btn" onclick="addGig()">Add Gig</button>

                <div class="item-list" id="gigsList">
                    <!-- Gigs will be displayed here -->
                </div>
            </div>

            <!-- Costs Section -->
            <div class="section">
                <h2>Costs</h2>
                
                <div class="toggle-section">
                    <label>
                        <input type="checkbox" id="splitTravelCosts" checked> 
                        Split all travel costs (car, parking, general travel) equally among all members
                    </label>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('car-travel')">Car Travel</div>
                    <div class="tab" onclick="switchTab('general-travel')">General Travel</div>
                    <div class="tab" onclick="switchTab('parking')">Parking</div>
                    <div class="tab" onclick="switchTab('food')">Food</div>
                    <div class="tab" onclick="switchTab('advertisement')">Advertisement</div>
                    <div class="tab" onclick="switchTab('other')">Other</div>
                </div>

                <!-- Car Travel Tab -->
                <div class="tab-content active" id="car-travel">
                    <div class="form-group">
                        <label>Cost Calculation Method</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" id="carCostPerKm" name="carCostMethod" value="per-km" checked>
                                <label for="carCostPerKm">Cost per kilometer</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" id="carCostFixed" name="carCostMethod" value="fixed">
                                <label for="carCostFixed">Fixed amount</label>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="carPerKmSection">
                        <div class="col">
                            <div class="form-group">
                                <label>Distance (km)</label>
                                <input type="number" id="carDistance" placeholder="0" step="1">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Cost per km (â‚¬)</label>
                                <input type="number" id="carCostPerKmRate" placeholder="0.20" step="0.01" value="0.20">
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="carFixedSection" style="display: none;">
                        <label>Fixed Amount (â‚¬)</label>
                        <input type="number" id="carFixedAmount" placeholder="0.00" step="0.01">
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Associated Gigs</label>
                                <div class="checkbox-group" id="carGigs">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Who paid for the car?</label>
                                <select id="carPayer">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="carUsersSection">
                        <label>Who used the car?</label>
                        <div class="checkbox-group" id="carUsers">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <button class="btn" onclick="addCarTravel()">Add Car Travel</button>
                </div>

                <!-- General Travel Tab -->
                <div class="tab-content" id="general-travel">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="travelDescription" placeholder="Travel description">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Amount (â‚¬)</label>
                                <input type="number" id="travelAmount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Associated Gigs</label>
                                <div class="checkbox-group" id="travelGigs">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Who paid?</label>
                                <select id="travelPayer">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="travelBeneficiariesSection">
                        <label>Who benefited from this travel?</label>
                        <div class="checkbox-group" id="travelBeneficiaries">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <button class="btn" onclick="addGeneralTravel()">Add Travel Cost</button>
                </div>

                <!-- Parking Tab -->
                <div class="tab-content" id="parking">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="parkingDescription" placeholder="Parking location">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Amount (â‚¬)</label>
                                <input type="number" id="parkingAmount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Associated Gigs</label>
                                <div class="checkbox-group" id="parkingGigs">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Who paid?</label>
                                <select id="parkingPayer">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="parkingBeneficiariesSection">
                        <label>Who benefited from this parking?</label>
                        <div class="checkbox-group" id="parkingBeneficiaries">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <button class="btn" onclick="addParking()">Add Parking Cost</button>
                </div>

                <!-- Food Tab -->
                <div class="tab-content" id="food">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="foodDescription" placeholder="Food description">
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Associated Gig</label>
                                <select id="foodGig">
                                    <option value="">Select a gig</option>
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Who consumed the food?</label>
                                <select id="foodConsumer">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Amount (â‚¬)</label>
                        <input type="number" id="foodAmount" placeholder="0.00" step="0.01">
                    </div>
                    
                    
                    <button class="btn" onclick="addFood()">Add Food Cost</button>
                </div>

                <!-- Advertisement Tab -->
                <div class="tab-content" id="advertisement">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="adDescription" placeholder="Advertisement description">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Amount (â‚¬)</label>
                                <input type="number" id="adAmount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Associated Gigs</label>
                                <div class="checkbox-group" id="adGigs">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Who paid?</label>
                                <select id="adPayer">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Who benefited from this advertisement?</label>
                        <div class="checkbox-group" id="adBeneficiaries">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <button class="btn" onclick="addAdvertisement()">Add Advertisement Cost</button>
                </div>

                <!-- Other Tab -->
                <div class="tab-content" id="other">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="otherDescription" placeholder="Other cost description">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Amount (â‚¬)</label>
                                <input type="number" id="otherAmount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Associated Gigs</label>
                                <div class="checkbox-group" id="otherGigs">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Who paid?</label>
                                <select id="otherPayer">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Who benefited from this expense?</label>
                        <div class="checkbox-group" id="otherBeneficiaries">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <button class="btn" onclick="addOther()">Add Other Cost</button>
                </div>

                <div class="item-list" id="costsList">
                    <!-- Costs will be displayed here -->
                </div>
            </div>

            <!-- Total Overview Section -->
            <div class="section">
                <h2>Share-Based Overview</h2>
                
                <div class="summary-grid">
                    <div class="summary-item" style="background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); color: white;">
                        <h3>Total Shares Created</h3>
                        <div class="amount" id="overviewTotalShares">0</div>
                        <small>From all gig participations</small>
                    </div>
                    <div class="summary-item" style="background: linear-gradient(135deg, #26D0CE 0%, #1A2980 100%); color: white;">
                        <h3>Share Value</h3>
                        <div class="amount" id="overviewShareValue">â‚¬0.00</div>
                        <small>Income per share</small>
                    </div>
                    <div class="summary-item" style="background: linear-gradient(135deg, #FFD93D 0%, #FF8C42 100%); color: white;">
                        <h3>Bandpot Shares</h3>
                        <div class="amount" id="overviewBandPotShares">0</div>
                        <small>Shares allocated to Bandpot</small>
                    </div>
                    <div class="summary-item" style="background: linear-gradient(135deg, #FF8E53 0%, #FF6B6B 100%); color: white;">
                        <h3>Member Shares</h3>
                        <div class="amount" id="overviewMemberShares">0</div>
                        <small>Shares for individual members</small>
                    </div>
                </div>

                <div class="summary-grid" style="margin-top: 20px;">
                    <div class="summary-item" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white;">
                        <h3>Total Expenses</h3>
                        <div class="amount" id="overviewTotalExpenses">â‚¬0.00</div>
                        <small>All costs combined</small>
                    </div>
                    <div class="summary-item" style="background: linear-gradient(135deg, #1DD1A1 0%, #10AC84 100%); color: white;">
                        <h3>Net After Expenses</h3>
                        <div class="amount" id="overviewNetResult">â‚¬0.00</div>
                        <small>Total income - expenses</small>
                    </div>
                    <div class="summary-item" style="background: linear-gradient(135deg, #5F27CD 0%, #341f97 100%); color: white;">
                        <h3>Total Gigs</h3>
                        <div class="amount" id="overviewTotalGigs">0</div>
                        <small>Number of performances</small>
                    </div>
                    <div class="summary-item" style="background: linear-gradient(135deg, #00d2d3 0%, #54a0ff 100%); color: white;">
                        <h3>Average Participants</h3>
                        <div class="amount" id="overviewAvgParticipants">0</div>
                        <small>Per gig</small>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: rgba(52, 73, 94, 0.1); border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Breakdown by Category</h3>
                    <div class="summary-grid">
                        <div class="summary-item" style="background: white; color: #2c3e50; border: 2px solid #4ECDC4;">
                            <h4>Car Travel</h4>
                            <div class="amount" id="overviewCarTravel">â‚¬0.00</div>
                        </div>
                        <div class="summary-item" style="background: white; color: #2c3e50; border: 2px solid #FF6B6B;">
                            <h4>General Travel</h4>
                            <div class="amount" id="overviewGeneralTravel">â‚¬0.00</div>
                        </div>
                        <div class="summary-item" style="background: white; color: #2c3e50; border: 2px solid #FFD93D;">
                            <h4>Parking</h4>
                            <div class="amount" id="overviewParking">â‚¬0.00</div>
                        </div>
                        <div class="summary-item" style="background: white; color: #2c3e50; border: 2px solid #1DD1A1;">
                            <h4>Food</h4>
                            <div class="amount" id="overviewFood">â‚¬0.00</div>
                        </div>
                        <div class="summary-item" style="background: white; color: #2c3e50; border: 2px solid #5F27CD;">
                            <h4>Advertisement</h4>
                            <div class="amount" id="overviewAdvertisement">â‚¬0.00</div>
                        </div>
                        <div class="summary-item" style="background: white; color: #2c3e50; border: 2px solid #FF8E53;">
                            <h4>Other</h4>
                            <div class="amount" id="overviewOther">â‚¬0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Section -->
            <div class="summary">
                <h2>Financial Summary</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchSummaryTab('ex-btw')" style="color: white;">Ex BTW</div>
                    <div class="tab" onclick="switchSummaryTab('inc-btw')" style="color: white;">Inc BTW (+9%)</div>
                </div>

                <div class="tab-content active" id="ex-btw-content">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <h3>Total Income</h3>
                            <div class="amount" id="totalIncomeEx">â‚¬0.00</div>
                        </div>
                        <div class="summary-item">
                            <h3>Total Costs</h3>
                            <div class="amount" id="totalCostsEx">â‚¬0.00</div>
                        </div>
                        <div class="summary-item">
                            <h3>Net Result</h3>
                            <div class="amount" id="netResultEx">â‚¬0.00</div>
                        </div>
                        <div class="summary-item">
                            <h3>Per Member</h3>
                            <div class="amount" id="perMemberEx">â‚¬0.00</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="inc-btw-content">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <h3>Total Income</h3>
                            <div class="amount" id="totalIncomeInc">â‚¬0.00</div>
                        </div>
                        <div class="summary-item">
                            <h3>Total Costs</h3>
                            <div class="amount" id="totalCostsInc">â‚¬0.00</div>
                        </div>
                        <div class="summary-item">
                            <h3>Net Result</h3>
                            <div class="amount" id="netResultInc">â‚¬0.00</div>
                        </div>
                        <div class="summary-item">
                            <h3>Per Member</h3>
                            <div class="amount" id="perMemberInc">â‚¬0.00</div>
                        </div>
                    </div>
                </div>

                <div class="member-breakdown">
                    <h3>Member Breakdown</h3>
                    <div class="tabs" style="margin-bottom: 20px;">
                        <div class="tab" onclick="switchMemberTab('summary')" style="color: white;">Summary</div>
                        <div class="tab active" onclick="switchMemberTab('detailed')" style="color: white;">Detailed</div>
                    </div>
                    
                    <div class="tab-content" id="member-summary">
                        <div id="memberBreakdown">
                            <!-- Member summary will be displayed here -->
                        </div>
                    </div>
                    
                    <div class="tab-content active" id="member-detailed">
                        <div id="memberDetailedBreakdown">
                            <!-- Detailed member breakdown will be displayed here -->
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="exportToPDF()">Export to PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
                    <button class="btn btn-secondary" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Band members
        const members = ['Max', 'Naut', 'Filip', 'Dani', 'Pedro', 'Roman', 'Frans', 'Steve', 'Kimo', 'Bandpot'];
        
        // Data storage
        let gigs = [];
        let costs = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSelectors();
            setupCarCostMethodToggle();
            setupSplitTravelCostsToggle();
            loadData();
            updateSummary();
        });

        function setupCarCostMethodToggle() {
            const perKmRadio = document.getElementById('carCostPerKm');
            const fixedRadio = document.getElementById('carCostFixed');
            const perKmSection = document.getElementById('carPerKmSection');
            const fixedSection = document.getElementById('carFixedSection');

            if (perKmRadio && fixedRadio && perKmSection && fixedSection) {
                perKmRadio.addEventListener('change', function() {
                    if (this.checked) {
                        perKmSection.style.display = 'flex';
                        fixedSection.style.display = 'none';
                    }
                });

                fixedRadio.addEventListener('change', function() {
                    if (this.checked) {
                        perKmSection.style.display = 'none';
                        fixedSection.style.display = 'block';
                    }
                });
                
                // Initial setup - ensure correct section is shown
                if (perKmRadio.checked) {
                    perKmSection.style.display = 'flex';
                    fixedSection.style.display = 'none';
                } else if (fixedRadio.checked) {
                    perKmSection.style.display = 'none';
                    fixedSection.style.display = 'block';
                }
            }
        }

        function setupSplitTravelCostsToggle() {
            const splitTravelCostsCheckbox = document.getElementById('splitTravelCosts');
            const carUsersSection = document.getElementById('carUsersSection');
            const travelBeneficiariesSection = document.getElementById('travelBeneficiariesSection');
            const parkingBeneficiariesSection = document.getElementById('parkingBeneficiariesSection');

            function toggleTravelSections() {
                const isChecked = splitTravelCostsCheckbox.checked;
                if (carUsersSection) carUsersSection.style.display = isChecked ? 'none' : 'block';
                if (travelBeneficiariesSection) travelBeneficiariesSection.style.display = isChecked ? 'none' : 'block';
                if (parkingBeneficiariesSection) parkingBeneficiariesSection.style.display = isChecked ? 'none' : 'block';
            }

            splitTravelCostsCheckbox.addEventListener('change', function() {
                toggleTravelSections();
                // Also trigger car cost method toggle to ensure proper display
                const carCostMethod = document.querySelector('input[name="carCostMethod"]:checked');
                if (carCostMethod) {
                    carCostMethod.dispatchEvent(new Event('change'));
                }
            });
            
            // Initial setup
            toggleTravelSections();
        }

        function initializeSelectors() {
            // Initialize gig participants
            const gigParticipants = document.getElementById('gigParticipants');
            members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="gig_${member}" value="${member}" checked>
                    <label for="gig_${member}">${member}</label>
                `;
                gigParticipants.appendChild(div);
            });

            // Initialize all payer selectors
            const payerSelectors = ['carPayer', 'travelPayer', 'parkingPayer', 'adPayer', 'otherPayer'];
            payerSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    selector.appendChild(option);
                });
            });

            // Initialize food consumer selector
            const foodConsumerSelector = document.getElementById('foodConsumer');
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                foodConsumerSelector.appendChild(option);
            });

            // Initialize car users (default: none selected)
            const carUsers = document.getElementById('carUsers');
            members.forEach(member => {
                if (member !== 'Bandpot') {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="car_${member}" value="${member}">
                        <label for="car_${member}">${member}</label>
                    `;
                    carUsers.appendChild(div);
                }
            });


            // Initialize travel beneficiaries (default: all selected)
            const travelBeneficiaries = document.getElementById('travelBeneficiaries');
            members.forEach(member => {
                if (member !== 'Bandpot') {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="travel_${member}" value="${member}" checked>
                        <label for="travel_${member}">${member}</label>
                    `;
                    travelBeneficiaries.appendChild(div);
                }
            });

            // Initialize parking beneficiaries (default: all selected)
            const parkingBeneficiaries = document.getElementById('parkingBeneficiaries');
            members.forEach(member => {
                if (member !== 'Bandpot') {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="parking_${member}" value="${member}" checked>
                        <label for="parking_${member}">${member}</label>
                    `;
                    parkingBeneficiaries.appendChild(div);
                }
            });

            // Initialize advertisement beneficiaries (default: all selected)
            const adBeneficiaries = document.getElementById('adBeneficiaries');
            members.forEach(member => {
                if (member !== 'Bandpot') {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="ad_${member}" value="${member}" checked>
                        <label for="ad_${member}">${member}</label>
                    `;
                    adBeneficiaries.appendChild(div);
                }
            });

            // Initialize other beneficiaries (default: all selected)
            const otherBeneficiaries = document.getElementById('otherBeneficiaries');
            members.forEach(member => {
                if (member !== 'Bandpot') {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="other_${member}" value="${member}" checked>
                        <label for="other_${member}">${member}</label>
                    `;
                    otherBeneficiaries.appendChild(div);
                }
            });
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function switchSummaryTab(tabName) {
            // Remove active class from summary tabs
            document.querySelectorAll('.summary .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.summary .tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Update summary and member breakdown to reflect BTW changes
            updateSummary();
        }

        function switchMemberTab(tabName) {
            // Remove active class from member tabs
            document.querySelectorAll('.member-breakdown .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.member-breakdown .tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById('member-' + tabName).classList.add('active');
            
            // Update member breakdown
            updateMemberBreakdown();
        }

        function addGig() {
            const name = document.getElementById('gigName').value;
            const amount = parseFloat(document.getElementById('gigAmount').value);
            
            if (!name || !amount) {
                alert('Please enter gig name and amount');
                return;
            }

            const participants = [];
            document.querySelectorAll('#gigParticipants input[type="checkbox"]:checked').forEach(checkbox => {
                participants.push(checkbox.value);
            });

            const gig = {
                id: Date.now(),
                name,
                amount,
                participants
            };

            gigs.push(gig);
            
            // Clear form
            document.getElementById('gigName').value = '';
            document.getElementById('gigAmount').value = '';
            
            saveData();
            displayGigs();
            updateSummary();
        }

        function addCarTravel() {
            const costMethod = document.querySelector('input[name="carCostMethod"]:checked').value;
            const payer = document.getElementById('carPayer').value;
            const splitTravelCosts = document.getElementById('splitTravelCosts').checked;
            let amount, description;
            
            // Get selected gigs
            const selectedGigs = [];
            document.querySelectorAll('#carGigs input[type="checkbox"]:checked').forEach(checkbox => {
                const gigId = parseInt(checkbox.value);
                const gig = gigs.find(g => g.id === gigId);
                if (gig) selectedGigs.push(gig);
            });
            
            if (selectedGigs.length === 0) {
                alert('Please select at least one associated gig');
                return;
            }
            
            if (costMethod === 'per-km') {
                const distance = parseInt(document.getElementById('carDistance').value);
                const costPerKm = parseFloat(document.getElementById('carCostPerKmRate').value);
                
                if (!distance || !costPerKm || !payer) {
                    alert('Please enter distance, cost per km, and who paid');
                    return;
                }
                
                amount = distance * costPerKm;
                description = `Car travel for ${selectedGigs.map(g => g.name).join(', ')}: ${distance}km @ â‚¬${costPerKm.toFixed(2)}/km`;
            } else {
                const fixedAmount = parseFloat(document.getElementById('carFixedAmount').value);
                
                if (!fixedAmount || !payer) {
                    alert('Please enter fixed amount and who paid');
                    return;
                }
                
                amount = fixedAmount;
                description = `Car travel for ${selectedGigs.map(g => g.name).join(', ')}: Fixed amount`;
            }

            let users = [];
            
            if (!splitTravelCosts) {
                // Legacy mode: use selected users
                document.querySelectorAll('#carUsers input[type="checkbox"]:checked').forEach(checkbox => {
                    users.push(checkbox.value);
                });

                if (users.length === 0) {
                    alert('Please select at least one car user');
                    return;
                }
            }

            const cost = {
                id: Date.now(),
                type: 'car-travel',
                description: description,
                amount: amount,
                payer,
                users: splitTravelCosts ? [] : users, // Empty array means split equally
                costMethod: costMethod,
                splitEqually: splitTravelCosts,
                gigIds: selectedGigs.map(g => g.id),
                gigNames: selectedGigs.map(g => g.name)
            };

            if (costMethod === 'per-km') {
                cost.distance = parseInt(document.getElementById('carDistance').value);
                cost.costPerKm = parseFloat(document.getElementById('carCostPerKmRate').value);
            }

            costs.push(cost);
            
            // Clear form
            if (costMethod === 'per-km') {
                document.getElementById('carDistance').value = '';
            } else {
                document.getElementById('carFixedAmount').value = '';
            }
            
            saveData();
            displayCosts();
            updateSummary();
        }

        function addGeneralTravel() {
            const description = document.getElementById('travelDescription').value;
            const amount = parseFloat(document.getElementById('travelAmount').value);
            const payer = document.getElementById('travelPayer').value;
            const splitTravelCosts = document.getElementById('splitTravelCosts').checked;
            
            if (!description || !amount || !payer) {
                alert('Please fill all fields');
                return;
            }
            
            // Get selected gigs
            const selectedGigs = [];
            document.querySelectorAll('#travelGigs input[type="checkbox"]:checked').forEach(checkbox => {
                const gigId = parseInt(checkbox.value);
                const gig = gigs.find(g => g.id === gigId);
                if (gig) selectedGigs.push(gig);
            });
            
            if (selectedGigs.length === 0) {
                alert('Please select at least one associated gig');
                return;
            }

            let beneficiaries = [];
            
            if (!splitTravelCosts) {
                // Legacy mode: use selected beneficiaries
                document.querySelectorAll('#travelBeneficiaries input[type="checkbox"]:checked').forEach(checkbox => {
                    beneficiaries.push(checkbox.value);
                });

                if (beneficiaries.length === 0) {
                    alert('Please select at least one beneficiary');
                    return;
                }
            }

            const cost = {
                id: Date.now(),
                type: 'general-travel',
                description: `Travel for ${selectedGigs.map(g => g.name).join(', ')}: ${description}`,
                amount,
                payer,
                beneficiaries: splitTravelCosts ? [] : beneficiaries, // Empty array means split equally
                splitEqually: splitTravelCosts,
                gigIds: selectedGigs.map(g => g.id),
                gigNames: selectedGigs.map(g => g.name)
            };

            costs.push(cost);
            
            // Clear form
            document.getElementById('travelDescription').value = '';
            document.getElementById('travelAmount').value = '';
            
            saveData();
            displayCosts();
            updateSummary();
        }

        function addParking() {
            const description = document.getElementById('parkingDescription').value;
            const amount = parseFloat(document.getElementById('parkingAmount').value);
            const payer = document.getElementById('parkingPayer').value;
            const splitTravelCosts = document.getElementById('splitTravelCosts').checked;
            
            if (!description || !amount || !payer) {
                alert('Please fill all fields');
                return;
            }
            
            // Get selected gigs
            const selectedGigs = [];
            document.querySelectorAll('#parkingGigs input[type="checkbox"]:checked').forEach(checkbox => {
                const gigId = parseInt(checkbox.value);
                const gig = gigs.find(g => g.id === gigId);
                if (gig) selectedGigs.push(gig);
            });
            
            if (selectedGigs.length === 0) {
                alert('Please select at least one associated gig');
                return;
            }

            let beneficiaries = [];
            
            if (!splitTravelCosts) {
                // Legacy mode: use selected beneficiaries
                document.querySelectorAll('#parkingBeneficiaries input[type="checkbox"]:checked').forEach(checkbox => {
                    beneficiaries.push(checkbox.value);
                });

                if (beneficiaries.length === 0) {
                    alert('Please select at least one beneficiary');
                    return;
                }
            }

            const cost = {
                id: Date.now(),
                type: 'parking',
                description: `Parking for ${selectedGigs.map(g => g.name).join(', ')}: ${description}`,
                amount,
                payer,
                beneficiaries: splitTravelCosts ? [] : beneficiaries, // Empty array means split equally
                splitEqually: splitTravelCosts,
                gigIds: selectedGigs.map(g => g.id),
                gigNames: selectedGigs.map(g => g.name)
            };

            costs.push(cost);
            
            // Clear form
            document.getElementById('parkingDescription').value = '';
            document.getElementById('parkingAmount').value = '';
            
            saveData();
            displayCosts();
            updateSummary();
        }

        function addFood() {
            const description = document.getElementById('foodDescription').value;
            const amount = parseFloat(document.getElementById('foodAmount').value);
            const gigId = document.getElementById('foodGig').value;
            const consumer = document.getElementById('foodConsumer').value;
            
            if (!description || !amount || !gigId || !consumer) {
                alert('Please fill all fields');
                return;
            }
            
            const associatedGig = gigs.find(gig => gig.id == gigId);
            if (!associatedGig) {
                alert('Selected gig not found');
                return;
            }

            const cost = {
                id: Date.now(),
                type: 'food',
                description: `Food for ${associatedGig.name}: ${description}`,
                amount: amount,
                consumer: consumer, // Individual who consumed the food
                individualCost: true, // Mark as individual cost
                gigId: parseInt(gigId),
                gigName: associatedGig.name
            };

            costs.push(cost);
            
            // Clear form
            document.getElementById('foodDescription').value = '';
            document.getElementById('foodAmount').value = '';
            
            saveData();
            displayCosts();
            updateSummary();
        }

        function addAdvertisement() {
            const description = document.getElementById('adDescription').value;
            const amount = parseFloat(document.getElementById('adAmount').value);
            const payer = document.getElementById('adPayer').value;
            
            if (!description || !amount || !payer) {
                alert('Please fill all fields');
                return;
            }
            
            // Get selected gigs
            const selectedGigs = [];
            document.querySelectorAll('#adGigs input[type="checkbox"]:checked').forEach(checkbox => {
                const gigId = parseInt(checkbox.value);
                const gig = gigs.find(g => g.id === gigId);
                if (gig) selectedGigs.push(gig);
            });
            
            if (selectedGigs.length === 0) {
                alert('Please select at least one associated gig');
                return;
            }

            const beneficiaries = [];
            document.querySelectorAll('#adBeneficiaries input[type="checkbox"]:checked').forEach(checkbox => {
                beneficiaries.push(checkbox.value);
            });

            if (beneficiaries.length === 0) {
                alert('Please select at least one beneficiary');
                return;
            }

            const cost = {
                id: Date.now(),
                type: 'advertisement',
                description: `Advertisement for ${selectedGigs.map(g => g.name).join(', ')}: ${description}`,
                amount,
                payer,
                beneficiaries,
                gigIds: selectedGigs.map(g => g.id),
                gigNames: selectedGigs.map(g => g.name)
            };

            costs.push(cost);
            
            // Clear form
            document.getElementById('adDescription').value = '';
            document.getElementById('adAmount').value = '';
            
            saveData();
            displayCosts();
            updateSummary();
        }

        function addOther() {
            const description = document.getElementById('otherDescription').value;
            const amount = parseFloat(document.getElementById('otherAmount').value);
            const payer = document.getElementById('otherPayer').value;
            
            if (!description || !amount || !payer) {
                alert('Please fill all fields');
                return;
            }
            
            // Get selected gigs
            const selectedGigs = [];
            document.querySelectorAll('#otherGigs input[type="checkbox"]:checked').forEach(checkbox => {
                const gigId = parseInt(checkbox.value);
                const gig = gigs.find(g => g.id === gigId);
                if (gig) selectedGigs.push(gig);
            });
            
            if (selectedGigs.length === 0) {
                alert('Please select at least one associated gig');
                return;
            }

            const beneficiaries = [];
            document.querySelectorAll('#otherBeneficiaries input[type="checkbox"]:checked').forEach(checkbox => {
                beneficiaries.push(checkbox.value);
            });

            if (beneficiaries.length === 0) {
                alert('Please select at least one beneficiary');
                return;
            }

            const cost = {
                id: Date.now(),
                type: 'other',
                description: `Other for ${selectedGigs.map(g => g.name).join(', ')}: ${description}`,
                amount,
                payer,
                beneficiaries,
                gigIds: selectedGigs.map(g => g.id),
                gigNames: selectedGigs.map(g => g.name)
            };

            costs.push(cost);
            
            // Clear form
            document.getElementById('otherDescription').value = '';
            document.getElementById('otherAmount').value = '';
            
            saveData();
            displayCosts();
            updateSummary();
        }

        function displayGigs() {
            const gigsList = document.getElementById('gigsList');
            gigsList.innerHTML = '';

            gigs.forEach(gig => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <div class="item-details">
                        <strong>${gig.name}</strong><br>
                        <small>Participants: ${gig.participants.join(', ')}</small>
                    </div>
                    <div class="item-amount">â‚¬${gig.amount.toFixed(2)}</div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="removeGig(${gig.id})">Remove</button>
                    </div>
                `;
                gigsList.appendChild(div);
            });
            
            // Update gig dropdowns in expense forms
            updateGigDropdowns();
        }

        function updateGigDropdowns() {
            const gigCheckboxGroups = [
                { id: 'carGigs', defaultChecked: false },
                { id: 'travelGigs', defaultChecked: false },
                { id: 'parkingGigs', defaultChecked: false },
                { id: 'adGigs', defaultChecked: true },  // Advertisement defaults to all gigs
                { id: 'otherGigs', defaultChecked: true }  // Other defaults to all gigs
            ];
            
            gigCheckboxGroups.forEach(group => {
                const container = document.getElementById(group.id);
                if (container) {
                    // Clear existing checkboxes
                    container.innerHTML = '';
                    
                    // Add gig checkboxes
                    gigs.forEach(gig => {
                        const div = document.createElement('div');
                        div.className = 'checkbox-item';
                        div.innerHTML = `
                            <input type="checkbox" id="${group.id}_${gig.id}" value="${gig.id}" ${group.defaultChecked ? 'checked' : ''}>
                            <label for="${group.id}_${gig.id}">${gig.name}</label>
                        `;
                        container.appendChild(div);
                    });
                }
            });

            // Update food gig dropdown (single selection)
            const foodGigSelector = document.getElementById('foodGig');
            if (foodGigSelector) {
                // Clear existing options except the first one
                while (foodGigSelector.children.length > 1) {
                    foodGigSelector.removeChild(foodGigSelector.lastChild);
                }
                
                // Add gig options
                gigs.forEach(gig => {
                    const option = document.createElement('option');
                    option.value = gig.id;
                    option.textContent = gig.name;
                    foodGigSelector.appendChild(option);
                });
            }
        }

        function displayCosts() {
            const costsList = document.getElementById('costsList');
            costsList.innerHTML = '';

            costs.forEach(cost => {
                const div = document.createElement('div');
                div.className = 'item';
                let details = `<strong>${cost.description}</strong><br><small>Paid by: ${cost.payer}`;
                
                if (cost.gigNames && cost.gigNames.length > 0) {
                    details += `<br>Gigs: ${cost.gigNames.join(', ')}`;
                } else if (cost.gigName) {
                    // Backward compatibility
                    details += `<br>Gig: ${cost.gigName}`;
                }
                
                if (cost.type === 'food' && cost.individualCost && cost.consumer) {
                    details += `<br>Consumed by: ${cost.consumer}`;
                } else if (cost.splitEqually) {
                    details += `<br>Split equally among all members`;
                } else if (cost.users && cost.users.length > 0) {
                    details += `<br>Used by: ${cost.users.join(', ')}`;
                } else if (cost.beneficiaries && cost.beneficiaries.length > 0) {
                    details += `<br>Benefited: ${cost.beneficiaries.join(', ')}`;
                } else if (cost.consumers) {
                    details += `<br>Consumed by: ${cost.consumers.join(', ')}`;
                }
                details += '</small>';

                div.innerHTML = `
                    <div class="item-details">${details}</div>
                    <div class="item-amount">â‚¬${cost.amount.toFixed(2)}</div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="removeCost(${cost.id})">Remove</button>
                    </div>
                `;
                costsList.appendChild(div);
            });
        }

        function removeGig(id) {
            gigs = gigs.filter(gig => gig.id !== id);
            saveData();
            displayGigs();
            updateSummary();
        }

        function removeCost(id) {
            costs = costs.filter(cost => cost.id !== id);
            saveData();
            displayCosts();
            updateSummary();
        }

        function updateSummary() {
            const socialWelfare = document.getElementById('socialWelfare').checked;
            const includeBandpotInExpenses = document.getElementById('includeBandpotInExpenses').checked;
            
            // Calculate totals
            let totalIncome = 0;
            
            if (socialWelfare && gigs.length > 0) {
                const averageAmount = gigs.reduce((sum, gig) => sum + gig.amount, 0) / gigs.length;
                totalIncome = averageAmount * gigs.length;
            } else {
                totalIncome = gigs.reduce((sum, gig) => sum + gig.amount, 0);
            }
            
            const totalCosts = costs.reduce((sum, cost) => sum + cost.amount, 0);
            const netResult = totalIncome - totalCosts;
            
            // Calculate total number of participants across all gigs
            let totalParticipants = 0;
            gigs.forEach(gig => {
                totalParticipants += gig.participants.length;
            });
            
            // Per member calculation based on actual gig participation
            const perMember = totalParticipants > 0 ? netResult / totalParticipants : 0;
            
            // Update Ex BTW (shows actual amounts without tax)
            document.getElementById('totalIncomeEx').textContent = `â‚¬${totalIncome.toFixed(2)}`;
            document.getElementById('totalCostsEx').textContent = `â‚¬${totalCosts.toFixed(2)}`;
            document.getElementById('netResultEx').textContent = `â‚¬${netResult.toFixed(2)}`;
            document.getElementById('perMemberEx').textContent = `â‚¬${perMember.toFixed(2)}`;
            
            // Inc BTW shows the same base amounts (BTW only applied to final member balances)
            document.getElementById('totalIncomeInc').textContent = `â‚¬${totalIncome.toFixed(2)}`;
            document.getElementById('totalCostsInc').textContent = `â‚¬${totalCosts.toFixed(2)}`;
            document.getElementById('netResultInc').textContent = `â‚¬${netResult.toFixed(2)}`;
            
            // Per member calculations with BTW
            const perMemberInc = perMember * 1.09;
            
            document.getElementById('perMemberEx').textContent = `â‚¬${perMember.toFixed(2)}`;
            document.getElementById('perMemberInc').textContent = `â‚¬${perMemberInc.toFixed(2)}`;
            
            // Update total overview
            updateTotalOverview();
            
            // Update member breakdown
            updateMemberBreakdown();
        }

        function updateTotalOverview() {
            const socialWelfare = document.getElementById('socialWelfare').checked;
            
            // Calculate total income
            let totalIncome = 0;
            if (socialWelfare && gigs.length > 0) {
                const averageAmount = gigs.reduce((sum, gig) => sum + gig.amount, 0) / gigs.length;
                totalIncome = averageAmount * gigs.length;
            } else {
                totalIncome = gigs.reduce((sum, gig) => sum + gig.amount, 0);
            }
            
            const totalExpenses = costs.reduce((sum, cost) => sum + cost.amount, 0);
            const netResult = totalIncome - totalExpenses;
            
            // Calculate total shares and share value
            let totalShares = 0;
            let bandPotShares = 0;
            let memberShares = 0;
            
            gigs.forEach(gig => {
                // Each participant gets 1 share per gig
                totalShares += gig.participants.length;
                gig.participants.forEach(participant => {
                    if (participant === 'Bandpot') {
                        bandPotShares += 1;
                    } else {
                        memberShares += 1;
                    }
                });
            });
            
            const shareValue = totalShares > 0 ? totalIncome / totalShares : 0;
            
            // Calculate average participants per gig
            const totalParticipants = gigs.reduce((sum, gig) => sum + gig.participants.length, 0);
            const avgParticipants = gigs.length > 0 ? (totalParticipants / gigs.length).toFixed(1) : 0;
            
            // Calculate costs by category
            const costsByCategory = {
                'car-travel': 0,
                'general-travel': 0,
                'parking': 0,
                'food': 0,
                'advertisement': 0,
                'other': 0
            };
            
            costs.forEach(cost => {
                if (costsByCategory.hasOwnProperty(cost.type)) {
                    costsByCategory[cost.type] += cost.amount;
                }
            });
            
            // Update share-based overview elements
            document.getElementById('overviewTotalShares').textContent = totalShares;
            document.getElementById('overviewShareValue').textContent = `â‚¬${shareValue.toFixed(2)}`;
            document.getElementById('overviewBandPotShares').textContent = bandPotShares;
            document.getElementById('overviewMemberShares').textContent = memberShares;
            document.getElementById('overviewTotalExpenses').textContent = `â‚¬${totalExpenses.toFixed(2)}`;
            document.getElementById('overviewNetResult').textContent = `â‚¬${netResult.toFixed(2)}`;
            document.getElementById('overviewTotalGigs').textContent = gigs.length;
            document.getElementById('overviewAvgParticipants').textContent = avgParticipants;
            
            // Update cost category breakdown
            document.getElementById('overviewCarTravel').textContent = `â‚¬${costsByCategory['car-travel'].toFixed(2)}`;
            document.getElementById('overviewGeneralTravel').textContent = `â‚¬${costsByCategory['general-travel'].toFixed(2)}`;
            document.getElementById('overviewParking').textContent = `â‚¬${costsByCategory['parking'].toFixed(2)}`;
            document.getElementById('overviewFood').textContent = `â‚¬${costsByCategory['food'].toFixed(2)}`;
            document.getElementById('overviewAdvertisement').textContent = `â‚¬${costsByCategory['advertisement'].toFixed(2)}`;
            document.getElementById('overviewOther').textContent = `â‚¬${costsByCategory['other'].toFixed(2)}`;
        }

        function updateMemberBreakdown() {
            const socialWelfare = document.getElementById('socialWelfare').checked;
            const includeBandpotInExpenses = document.getElementById('includeBandpotInExpenses').checked;
            const memberBalances = {};
            const memberShares = {};
            const memberExpenses = {};
            
            // Initialize data structures
            members.forEach(member => {
                memberBalances[member] = 0;
                memberShares[member] = 0;
                memberExpenses[member] = 0;
            });
            
            // Calculate shares from gigs
            if (socialWelfare && gigs.length > 0) {
                // In social welfare mode, calculate a universal share value
                const totalIncome = gigs.reduce((sum, gig) => sum + gig.amount, 0);
                const averageAmount = totalIncome / gigs.length;
                let totalShares = 0;
                
                // Count total shares
                gigs.forEach(gig => {
                    totalShares += gig.participants.length;
                });
                
                const universalShareValue = totalIncome / totalShares;
                
                // Apply universal share value to each participant
                gigs.forEach(gig => {
                    gig.participants.forEach(participant => {
                        memberBalances[participant] += universalShareValue;
                        memberShares[participant] += universalShareValue;
                    });
                });
            } else {
                // Normal mode - each gig pays its actual amount
                gigs.forEach(gig => {
                    const participantShare = gig.amount / gig.participants.length;
                    gig.participants.forEach(participant => {
                        memberBalances[participant] += participantShare;
                        memberShares[participant] += participantShare;
                    });
                });
            }
            
            // Calculate expenses
            costs.forEach(cost => {
                if ((cost.type === 'car-travel' || cost.type === 'general-travel' || cost.type === 'parking') && cost.splitEqually) {
                    // Travel costs with equal splitting
                    const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                    const costPerMember = cost.amount / activeMemberCount;
                    
                    members.forEach(member => {
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            memberBalances[member] -= costPerMember;
                            memberExpenses[member] += costPerMember;
                        }
                    });
                    memberBalances[cost.payer] += cost.amount; // Refund the payer
                } else if (cost.type === 'car-travel' && cost.users && cost.users.length > 0) {
                    // Legacy car travel: split among selected users
                    const costPerUser = cost.amount / cost.users.length;
                    cost.users.forEach(user => {
                        memberBalances[user] -= costPerUser;
                        memberExpenses[user] += costPerUser;
                    });
                    memberBalances[cost.payer] += cost.amount; // Refund the payer
                } else if ((cost.type === 'general-travel' || cost.type === 'parking') && cost.beneficiaries && cost.beneficiaries.length > 0) {
                    // Legacy travel/parking: split among selected beneficiaries
                    const costPerBeneficiary = cost.amount / cost.beneficiaries.length;
                    cost.beneficiaries.forEach(beneficiary => {
                        memberBalances[beneficiary] -= costPerBeneficiary;
                        memberExpenses[beneficiary] += costPerBeneficiary;
                    });
                    memberBalances[cost.payer] += cost.amount; // Refund the payer
                } else if (cost.type === 'food' && cost.individualCost && cost.consumer) {
                    // Food is an individual cost - only the consumer pays
                    memberBalances[cost.consumer] -= cost.amount;
                    memberExpenses[cost.consumer] += cost.amount;
                } else if (cost.type === 'food' && cost.consumers) {
                    // Legacy food cost handling (for backward compatibility)
                    const costPerConsumer = cost.amount / cost.consumers.length;
                    cost.consumers.forEach(consumer => {
                        memberBalances[consumer] -= costPerConsumer;
                        memberExpenses[consumer] += costPerConsumer;
                    });
                    if (cost.payer) {
                        memberBalances[cost.payer] += cost.amount; // Refund the payer
                    }
                } else {
                    // Other costs
                    const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                    const costPerMember = cost.amount / activeMemberCount;
                    
                    members.forEach(member => {
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            memberBalances[member] -= costPerMember;
                            memberExpenses[member] += costPerMember;
                        }
                    });
                    memberBalances[cost.payer] += cost.amount; // Refund the payer
                }
            });
            
            // Check which tab is active to determine BTW application
            const incBtwTab = document.getElementById('inc-btw-content');
            const isIncBtwActive = incBtwTab && incBtwTab.classList.contains('active');
            
            // Check which member tab is active
            const detailedTab = document.getElementById('member-detailed');
            const isDetailedActive = detailedTab && detailedTab.classList.contains('active');
            
            if (isDetailedActive) {
                updateDetailedMemberBreakdown(memberShares, memberExpenses, memberBalances, isIncBtwActive);
            } else {
                updateSummaryMemberBreakdown(memberBalances, isIncBtwActive);
            }
        }
        
        function updateSummaryMemberBreakdown(memberBalances, isIncBtwActive) {
            const memberBreakdown = document.getElementById('memberBreakdown');
            memberBreakdown.innerHTML = '';
            
            members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'member-item';
                const balance = memberBalances[member];
                
                // Apply BTW only to final member balances if Inc BTW tab is active
                const finalBalance = isIncBtwActive ? balance * 1.09 : balance;
                
                div.innerHTML = `
                    <span style="color: white;">${member}</span>
                    <span style="color: white; font-weight: bold;">â‚¬${finalBalance.toFixed(2)}</span>
                `;
                memberBreakdown.appendChild(div);
            });
        }
        
        function updateDetailedMemberBreakdown(memberShares, memberExpenses, memberBalances, isIncBtwActive) {
            const memberDetailedBreakdown = document.getElementById('memberDetailedBreakdown');
            memberDetailedBreakdown.innerHTML = '';
            
            // Calculate individual expenses (what each member paid out of pocket)
            const memberIndividualExpenses = {};
            members.forEach(member => {
                memberIndividualExpenses[member] = 0;
            });
            
            costs.forEach(cost => {
                // Add what each member paid out of pocket (before refunds/splits)
                memberIndividualExpenses[cost.payer] += cost.amount;
            });
            
            members.forEach(member => {
                const shares = memberShares[member];
                const expenses = memberExpenses[member];
                const individualExpenses = memberIndividualExpenses[member];
                const balance = memberBalances[member];
                const finalBalance = isIncBtwActive ? balance * 1.09 : balance;
                
                const memberDiv = document.createElement('div');
                memberDiv.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    margin-bottom: 20px;
                    border-left: 6px solid ${member === 'Bandpot' ? '#FFD93D' : '#4ECDC4'};
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                `;
                
                // Calculate gig participation count
                let gigCount = 0;
                gigs.forEach(gig => {
                    if (gig.participants.includes(member)) {
                        gigCount++;
                    }
                });
                
                memberDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
                        <h4 style="color: #2c3e50; margin: 0; font-size: 1.3em; font-weight: bold;">${member}</h4>
                        <span style="color: ${finalBalance >= 0 ? '#1DD1A1' : '#FF6B6B'}; font-weight: bold; font-size: 1.4em;">â‚¬${finalBalance.toFixed(2)}</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div style="background: #E8F8F5; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="color: #1DD1A1; font-weight: bold; font-size: 0.9em;">INCOME</div>
                            <div style="color: #2c3e50; font-weight: bold; font-size: 1.1em;">â‚¬${shares.toFixed(2)}</div>
                            <div style="color: #7f8c8d; font-size: 0.8em;">${gigCount} gigs</div>
                        </div>
                        
                        <div style="background: #FFEBEE; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="color: #FF6B6B; font-weight: bold; font-size: 0.9em;">SHARED COSTS</div>
                            <div style="color: #2c3e50; font-weight: bold; font-size: 1.1em;">â‚¬${expenses.toFixed(2)}</div>
                            <div style="color: #7f8c8d; font-size: 0.8em;">Split expenses</div>
                        </div>
                        
                        <div style="background: #FFF3E0; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="color: #FF8C42; font-weight: bold; font-size: 0.9em;">PAID OUT</div>
                            <div style="color: #2c3e50; font-weight: bold; font-size: 1.1em;">â‚¬${individualExpenses.toFixed(2)}</div>
                            <div style="color: #7f8c8d; font-size: 0.8em;">Individual payments</div>
                        </div>
                        
                        <div style="background: ${finalBalance >= 0 ? '#E8F5E8' : '#FFEBEE'}; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="color: ${finalBalance >= 0 ? '#1DD1A1' : '#FF6B6B'}; font-weight: bold; font-size: 0.9em;">NET RESULT</div>
                            <div style="color: #2c3e50; font-weight: bold; font-size: 1.1em;">â‚¬${finalBalance.toFixed(2)}</div>
                            <div style="color: #7f8c8d; font-size: 0.8em;">${isIncBtwActive ? 'Inc. BTW' : 'Ex BTW'}</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.85em; color: #7f8c8d; text-align: center; padding-top: 10px; border-top: 1px solid #f0f0f0;">
                        ${member === 'Bandpot' ? 'Band fund for equipment and future investments' : 
                          finalBalance >= 0 ? 'Amount to receive' : 'Amount to contribute'}
                    </div>
                `;
                
                memberDetailedBreakdown.appendChild(memberDiv);
            });
        }

        function saveData() {
            const data = {
                gigs,
                costs,
                socialWelfare: document.getElementById('socialWelfare').checked,
                splitTravelCosts: document.getElementById('splitTravelCosts').checked,
                includeBandpotInExpenses: document.getElementById('includeBandpotInExpenses').checked
            };
            localStorage.setItem('bandFinances', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('bandFinances');
            if (saved) {
                const data = JSON.parse(saved);
                gigs = data.gigs || [];
                costs = data.costs || [];
                
                if (data.socialWelfare !== undefined) {
                    document.getElementById('socialWelfare').checked = data.socialWelfare;
                } else {
                    // Default to checked if no saved preference
                    document.getElementById('socialWelfare').checked = true;
                }
                
                if (data.splitTravelCosts !== undefined) {
                    document.getElementById('splitTravelCosts').checked = data.splitTravelCosts;
                } else {
                    // Default to checked if no saved preference
                    document.getElementById('splitTravelCosts').checked = true;
                }
                
                if (data.includeBandpotInExpenses !== undefined) {
                    document.getElementById('includeBandpotInExpenses').checked = data.includeBandpotInExpenses;
                } else {
                    // Default to checked if no saved preference
                    document.getElementById('includeBandpotInExpenses').checked = true;
                }
                
                displayGigs();
                displayCosts();
                updateSummary();
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                gigs = [];
                costs = [];
                localStorage.removeItem('bandFinances');
                displayGigs();
                displayCosts();
                updateSummary();
                
                // Reset social welfare checkbox
                document.getElementById('socialWelfare').checked = false;
            }
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const socialWelfare = document.getElementById('socialWelfare').checked;
            const includeBandpotInExpenses = document.getElementById('includeBandpotInExpenses').checked;
            const splitTravelCosts = document.getElementById('splitTravelCosts').checked;
            
            // Header with logo space and title
            doc.setFillColor(255, 107, 107); // Coral color
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('SPULL BAND', 105, 18, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Financial Overview', 105, 28, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 35, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 50;
            
            // Settings Section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Settings', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Social Welfare Mode: ${socialWelfare ? 'Enabled' : 'Disabled'}`, 25, y);
            y += 6;
            doc.text(`Include Bandpot in Expenses: ${includeBandpotInExpenses ? 'Yes' : 'No'}`, 25, y);
            y += 6;
            doc.text(`Split Travel Costs Equally: ${splitTravelCosts ? 'Yes' : 'No'}`, 25, y);
            y += 15;
            
            // Calculate all data
            let totalIncome = 0;
            if (socialWelfare && gigs.length > 0) {
                const averageAmount = gigs.reduce((sum, gig) => sum + gig.amount, 0) / gigs.length;
                totalIncome = averageAmount * gigs.length;
            } else {
                totalIncome = gigs.reduce((sum, gig) => sum + gig.amount, 0);
            }
            
            const totalExpenses = costs.reduce((sum, cost) => sum + cost.amount, 0);
            const netResult = totalIncome - totalExpenses;
            
            // Calculate shares for PDF export
            let totalSharesPdf = 0;
            let bandPotSharesPdf = 0;
            let memberSharesPdf = 0;
            
            gigs.forEach(gig => {
                totalSharesPdf += gig.participants.length;
                gig.participants.forEach(participant => {
                    if (participant === 'Bandpot') {
                        bandPotSharesPdf += 1;
                    } else {
                        memberSharesPdf += 1;
                    }
                });
            });
            
            const shareValue = totalSharesPdf > 0 ? totalIncome / totalSharesPdf : 0;
            const avgParticipants = gigs.length > 0 ? (totalSharesPdf / gigs.length).toFixed(1) : 0;
            
            // Share-Based Overview
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Share-Based Overview', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Shares Created: ${totalSharesPdf}`, 25, y);
            y += 6;
            doc.text(`Share Value: â‚¬${shareValue.toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Bandpot Shares: ${bandPotSharesPdf}`, 25, y);
            y += 6;
            doc.text(`Member Shares: ${memberSharesPdf}`, 25, y);
            y += 15;
            
            // Financial Summary
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Financial Summary', 20, y);
            y += 8;
            
            // Calculate sum of personal expenses and income
            let totalPersonalIncome = 0;
            let totalPersonalExpenses = 0;
            
            // Calculate personal totals from member breakdown
            const tempMemberBalances = {};
            const tempMemberShares = {};
            const tempMemberExpenses = {};
            
            members.forEach(member => {
                tempMemberBalances[member] = 0;
                tempMemberShares[member] = 0;
                tempMemberExpenses[member] = 0;
            });
            
            // Calculate shares from gigs
            if (socialWelfare && gigs.length > 0) {
                // In social welfare mode, calculate a universal share value
                const totalIncomeForShares = gigs.reduce((sum, gig) => sum + gig.amount, 0);
                let totalSharesForCalc = 0;
                
                // Count total shares
                gigs.forEach(gig => {
                    totalSharesForCalc += gig.participants.length;
                });
                
                const universalShareValue = totalIncomeForShares / totalSharesForCalc;
                
                // Apply universal share value to each participant
                gigs.forEach(gig => {
                    gig.participants.forEach(participant => {
                        tempMemberShares[participant] += universalShareValue;
                    });
                });
            } else {
                // Normal mode - each gig pays its actual amount
                gigs.forEach(gig => {
                    const participantShare = gig.amount / gig.participants.length;
                    gig.participants.forEach(participant => {
                        tempMemberShares[participant] += participantShare;
                    });
                });
            }
            
            // Calculate expenses
            costs.forEach(cost => {
                if (cost.type === 'food' && cost.individualCost && cost.consumer) {
                    tempMemberExpenses[cost.consumer] += cost.amount;
                } else if ((cost.type === 'car-travel' || cost.type === 'general-travel' || cost.type === 'parking') && cost.splitEqually) {
                    const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                    const costPerMember = cost.amount / activeMemberCount;
                    members.forEach(member => {
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            tempMemberExpenses[member] += costPerMember;
                        }
                    });
                }
                // Add other expense calculations as needed
            });
            
            // Sum up totals
            members.forEach(member => {
                totalPersonalIncome += tempMemberShares[member];
                totalPersonalExpenses += tempMemberExpenses[member];
            });
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Income: â‚¬${totalIncome.toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Total Expenses: â‚¬${totalExpenses.toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Sum of Personal Income: â‚¬${totalPersonalIncome.toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Sum of Personal Expenses: â‚¬${totalPersonalExpenses.toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Net Result: â‚¬${netResult.toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Total Gigs: ${gigs.length}`, 25, y);
            y += 15;
            
            // Expense Breakdown by Category
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Expense Breakdown by Category', 20, y);
            y += 8;
            
            const costsByCategory = {
                'car-travel': 0,
                'general-travel': 0,
                'parking': 0,
                'food': 0,
                'advertisement': 0,
                'other': 0
            };
            
            costs.forEach(cost => {
                if (costsByCategory.hasOwnProperty(cost.type)) {
                    costsByCategory[cost.type] += cost.amount;
                }
            });
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Car Travel: â‚¬${costsByCategory['car-travel'].toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`General Travel: â‚¬${costsByCategory['general-travel'].toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Parking: â‚¬${costsByCategory['parking'].toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Food: â‚¬${costsByCategory['food'].toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Advertisement: â‚¬${costsByCategory['advertisement'].toFixed(2)}`, 25, y);
            y += 6;
            doc.text(`Other: â‚¬${costsByCategory['other'].toFixed(2)}`, 25, y);
            y += 15;
            
            // Check if we need a new page
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            
            // Member Breakdown
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Detailed Member Breakdown', 20, y);
            y += 10;
            
            // Calculate detailed member data for PDF
            const pdfMemberBalances = {};
            const pdfMemberShares = {};
            const pdfMemberExpenses = {};
            
            members.forEach(member => {
                pdfMemberBalances[member] = 0;
                pdfMemberShares[member] = 0;
                pdfMemberExpenses[member] = 0;
            });
            
            // Calculate shares from gigs
            if (socialWelfare && gigs.length > 0) {
                // In social welfare mode, calculate a universal share value
                const totalIncomeForShares = gigs.reduce((sum, gig) => sum + gig.amount, 0);
                let totalSharesForCalc = 0;
                
                // Count total shares
                gigs.forEach(gig => {
                    totalSharesForCalc += gig.participants.length;
                });
                
                const universalShareValue = totalIncomeForShares / totalSharesForCalc;
                
                // Apply universal share value to each participant
                gigs.forEach(gig => {
                    gig.participants.forEach(participant => {
                        pdfMemberBalances[participant] += universalShareValue;
                        pdfMemberShares[participant] += universalShareValue;
                    });
                });
            } else {
                // Normal mode - each gig pays its actual amount
                gigs.forEach(gig => {
                    const participantShare = gig.amount / gig.participants.length;
                    gig.participants.forEach(participant => {
                        pdfMemberBalances[participant] += participantShare;
                        pdfMemberShares[participant] += participantShare;
                    });
                });
            }
            
            // Calculate expenses
            costs.forEach(cost => {
                if ((cost.type === 'car-travel' || cost.type === 'general-travel' || cost.type === 'parking') && cost.splitEqually) {
                    const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                    const costPerMember = cost.amount / activeMemberCount;
                    
                    members.forEach(member => {
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            pdfMemberBalances[member] -= costPerMember;
                            pdfMemberExpenses[member] += costPerMember;
                        }
                    });
                    pdfMemberBalances[cost.payer] += cost.amount;
                } else if (cost.type === 'car-travel' && cost.users && cost.users.length > 0) {
                    const costPerUser = cost.amount / cost.users.length;
                    cost.users.forEach(user => {
                        pdfMemberBalances[user] -= costPerUser;
                        pdfMemberExpenses[user] += costPerUser;
                    });
                    pdfMemberBalances[cost.payer] += cost.amount;
                } else if ((cost.type === 'general-travel' || cost.type === 'parking') && cost.beneficiaries && cost.beneficiaries.length > 0) {
                    const costPerBeneficiary = cost.amount / cost.beneficiaries.length;
                    cost.beneficiaries.forEach(beneficiary => {
                        pdfMemberBalances[beneficiary] -= costPerBeneficiary;
                        pdfMemberExpenses[beneficiary] += costPerBeneficiary;
                    });
                    pdfMemberBalances[cost.payer] += cost.amount;
                } else if (cost.type === 'food' && cost.consumers) {
                    const costPerConsumer = cost.amount / cost.consumers.length;
                    cost.consumers.forEach(consumer => {
                        pdfMemberBalances[consumer] -= costPerConsumer;
                        pdfMemberExpenses[consumer] += costPerConsumer;
                    });
                    pdfMemberBalances[cost.payer] += cost.amount;
                } else {
                    const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                    const costPerMember = cost.amount / activeMemberCount;
                    
                    members.forEach(member => {
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            pdfMemberBalances[member] -= costPerMember;
                            pdfMemberExpenses[member] += costPerMember;
                        }
                    });
                    pdfMemberBalances[cost.payer] += cost.amount;
                }
            });
            
            // Check if we need a new page
            if (y > 200) {
                doc.addPage();
                y = 20;
            }
            
            // Simple Table Overview
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Member Summary Table', 20, y);
            y += 10;
            
            // Table headers
            doc.setFillColor(78, 205, 196); // Turquoise header
            doc.rect(20, y - 2, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Member', 25, y + 3);
            doc.text('Shares', 70, y + 3);
            doc.text('Income (â‚¬)', 95, y + 3);
            doc.text('Expenses (â‚¬)', 125, y + 3);
            doc.text('Net (â‚¬)', 155, y + 3);
            doc.text('Net+BTW (â‚¬)', 175, y + 3);
            y += 10;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            
            // Table rows
            members.forEach((member, index) => {
                const income = pdfMemberShares[member];
                const expenses = pdfMemberExpenses[member];
                const balance = pdfMemberBalances[member];
                const balanceWithBTW = balance * 1.09;
                
                // Count shares for this member
                let shareCount = 0;
                gigs.forEach(gig => {
                    if (gig.participants.includes(member)) {
                        shareCount++;
                    }
                });
                
                // Alternating row colors
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(20, y - 2, 170, 6, 'F');
                }
                
                doc.setTextColor(0, 0, 0);
                doc.text(member, 25, y + 2);
                doc.text(shareCount.toString(), 70, y + 2);
                doc.text(`â‚¬${income.toFixed(2)}`, 95, y + 2);
                doc.text(`â‚¬${expenses.toFixed(2)}`, 125, y + 2);
                
                // Color code the net result
                doc.setTextColor(balance >= 0 ? 27 : 231, balance >= 0 ? 174 : 76, balance >= 0 ? 97 : 76);
                doc.text(`â‚¬${balance.toFixed(2)}`, 155, y + 2);
                doc.text(`â‚¬${balanceWithBTW.toFixed(2)}`, 175, y + 2);
                doc.setTextColor(0, 0, 0);
                
                y += 6;
            });
            
            // Summary row
            y += 5;
            doc.setFillColor(52, 73, 94); // Dark header
            doc.rect(20, y - 2, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('TOTALS', 25, y + 3);
            
            const totalIncomeSum = members.reduce((sum, member) => sum + pdfMemberShares[member], 0);
            const totalExpensesSum = members.reduce((sum, member) => sum + pdfMemberExpenses[member], 0);
            const totalNetSum = members.reduce((sum, member) => sum + pdfMemberBalances[member], 0);
            const totalNetBTWSum = totalNetSum * 1.09;
            
            doc.text(`â‚¬${totalIncomeSum.toFixed(2)}`, 95, y + 3);
            doc.text(`â‚¬${totalExpensesSum.toFixed(2)}`, 125, y + 3);
            doc.text(`â‚¬${totalNetSum.toFixed(2)}`, 155, y + 3);
            doc.text(`â‚¬${totalNetBTWSum.toFixed(2)}`, 175, y + 3);
            y += 15;
            
            doc.setTextColor(0, 0, 0);
            
            // Check if we need a new page for detailed breakdown
            if (y > 200) {
                doc.addPage();
                y = 20;
            }
            
            // Complete Member Breakdown
            members.forEach(member => {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }
                
                const income = pdfMemberShares[member];
                const expenses = pdfMemberExpenses[member];
                const balance = pdfMemberBalances[member];
                const balanceWithBTW = balance * 1.09;
                
                // Member header
                doc.setFillColor(78, 205, 196); // Turquoise
                if (member === 'Bandpot') {
                    doc.setFillColor(255, 217, 61); // Golden
                }
                doc.rect(20, y - 5, 170, 12, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(member, 25, y + 3);
                doc.text(`Final: â‚¬${balanceWithBTW.toFixed(2)}`, 180, y + 3, { align: 'right' });
                y += 15;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // Income breakdown
                doc.setFont(undefined, 'bold');
                doc.text('INCOME BREAKDOWN:', 25, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                
                let memberGigCount = 0;
                let universalShareValue = 0;
                
                if (socialWelfare && gigs.length > 0) {
                    // Calculate universal share value for social welfare mode
                    const totalIncomeForShares = gigs.reduce((sum, gig) => sum + gig.amount, 0);
                    let totalSharesForCalc = 0;
                    gigs.forEach(gig => {
                        totalSharesForCalc += gig.participants.length;
                    });
                    universalShareValue = totalIncomeForShares / totalSharesForCalc;
                }
                
                gigs.forEach(gig => {
                    if (gig.participants.includes(member)) {
                        memberGigCount++;
                        let shareValue;
                        
                        if (socialWelfare && gigs.length > 0) {
                            shareValue = universalShareValue;
                            doc.text(`  ${gig.name}: â‚¬${shareValue.toFixed(2)} (universal share)`, 30, y);
                        } else {
                            shareValue = gig.amount / gig.participants.length;
                            doc.text(`  ${gig.name}: â‚¬${shareValue.toFixed(2)} (${gig.participants.length} participants)`, 30, y);
                        }
                        y += 5;
                    }
                });
                
                if (memberGigCount === 0) {
                    doc.text('  No gig participation', 30, y);
                    y += 5;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`Total Income: â‚¬${income.toFixed(2)}`, 30, y);
                y += 10;
                
                // Expense breakdown
                doc.setFont(undefined, 'bold');
                doc.text('EXPENSE BREAKDOWN:', 25, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                
                let hasExpenses = false;
                costs.forEach(cost => {
                    let memberCost = 0;
                    let reason = '';
                    
                    if (cost.type === 'food' && cost.individualCost && cost.consumer === member) {
                        memberCost = cost.amount;
                        reason = 'Individual food expense';
                    } else if ((cost.type === 'car-travel' || cost.type === 'general-travel' || cost.type === 'parking') && cost.splitEqually) {
                        const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            memberCost = cost.amount / activeMemberCount;
                            reason = 'Equal split';
                        }
                    } else if (cost.users && cost.users.includes(member)) {
                        memberCost = cost.amount / cost.users.length;
                        reason = 'Group expense';
                    } else if (cost.beneficiaries && cost.beneficiaries.includes(member)) {
                        memberCost = cost.amount / cost.beneficiaries.length;
                        reason = 'Group expense';
                    } else if (cost.consumers && cost.consumers.includes(member)) {
                        memberCost = cost.amount / cost.consumers.length;
                        reason = 'Group expense';
                    } else if (!cost.splitEqually && (cost.type === 'advertisement' || cost.type === 'other')) {
                        const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            memberCost = cost.amount / activeMemberCount;
                            reason = 'Equal split';
                        }
                    }
                    
                    if (memberCost > 0) {
                        hasExpenses = true;
                        const gigInfo = cost.gigNames ? cost.gigNames.join(', ') : (cost.gigName || 'N/A');
                        doc.text(`  ${cost.description}: â‚¬${memberCost.toFixed(2)} (${reason})`, 30, y);
                        y += 5;
                    }
                });
                
                if (!hasExpenses) {
                    doc.text('  No expenses', 30, y);
                    y += 5;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`Total Expenses: â‚¬${expenses.toFixed(2)}`, 30, y);
                y += 6;
                doc.text(`NET RESULT: â‚¬${balance.toFixed(2)} (â‚¬${balanceWithBTW.toFixed(2)} inc. BTW)`, 30, y);
                y += 20;
            });
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Generated by Spull Band Financial Tracker', 105, 295, { align: 'center' });
            }
            
            doc.save('spull-band-finances.pdf');
        }

        function exportToExcel() {
            const socialWelfare = document.getElementById('socialWelfare').checked;
            const includeBandpotInExpenses = document.getElementById('includeBandpotInExpenses').checked;
            const splitTravelCosts = document.getElementById('splitTravelCosts').checked;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Calculate totals for overview
            let totalIncome = 0;
            if (socialWelfare && gigs.length > 0) {
                const averageAmount = gigs.reduce((sum, gig) => sum + gig.amount, 0) / gigs.length;
                totalIncome = averageAmount * gigs.length;
            } else {
                totalIncome = gigs.reduce((sum, gig) => sum + gig.amount, 0);
            }
            
            const totalExpenses = costs.reduce((sum, cost) => sum + cost.amount, 0);
            const netResult = totalIncome - totalExpenses;
            
            // Calculate shares for Excel export
            let totalSharesExcel = 0;
            let bandPotSharesExcel = 0;
            let memberSharesExcel = 0;
            
            gigs.forEach(gig => {
                totalSharesExcel += gig.participants.length;
                gig.participants.forEach(participant => {
                    if (participant === 'Bandpot') {
                        bandPotSharesExcel += 1;
                    } else {
                        memberSharesExcel += 1;
                    }
                });
            });
            
            const shareValue = totalSharesExcel > 0 ? totalIncome / totalSharesExcel : 0;
            const avgParticipants = gigs.length > 0 ? (totalSharesExcel / gigs.length).toFixed(1) : 0;
            
            // Calculate costs by category for Excel
            const costsByCategoryExcel = {
                'car-travel': 0,
                'general-travel': 0,
                'parking': 0,
                'food': 0,
                'advertisement': 0,
                'other': 0
            };
            
            costs.forEach(cost => {
                if (costsByCategoryExcel.hasOwnProperty(cost.type)) {
                    costsByCategoryExcel[cost.type] += cost.amount;
                }
            });
            
            // Create Overview sheet
            const overviewData = [
                ['SPULL BAND FINANCIAL OVERVIEW'],
                ['Generated:', new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString()],
                [],
                ['SETTINGS'],
                ['Social Welfare Mode:', socialWelfare ? 'Yes' : 'No'],
                ['Include Bandpot in Expenses:', includeBandpotInExpenses ? 'Yes' : 'No'],
                ['Split Travel Costs Equally:', splitTravelCosts ? 'Yes' : 'No'],
                [],
                ['SHARE-BASED OVERVIEW'],
                ['Total Shares Created', totalSharesExcel],
                ['Share Value', 'â‚¬' + shareValue.toFixed(2)],
                ['Bandpot Shares', bandPotSharesExcel],
                ['Member Shares', memberSharesExcel],
                [],
                ['FINANCIAL SUMMARY'],
                ['Total Income', 'â‚¬' + totalIncome.toFixed(2)],
                ['Total Expenses', 'â‚¬' + totalExpenses.toFixed(2)],
                ['Net Result', 'â‚¬' + netResult.toFixed(2)],
                ['Total Gigs', gigs.length],
                ['Average Participants per Gig', avgParticipants],
                [],
                ['EXPENSE BREAKDOWN BY CATEGORY'],
                ['Car Travel', 'â‚¬' + costsByCategoryExcel['car-travel'].toFixed(2)],
                ['General Travel', 'â‚¬' + costsByCategoryExcel['general-travel'].toFixed(2)],
                ['Parking', 'â‚¬' + costsByCategoryExcel['parking'].toFixed(2)],
                ['Food', 'â‚¬' + costsByCategoryExcel['food'].toFixed(2)],
                ['Advertisement', 'â‚¬' + costsByCategoryExcel['advertisement'].toFixed(2)],
                ['Other', 'â‚¬' + costsByCategoryExcel['other'].toFixed(2)]
            ];
            
            const overviewWs = XLSX.utils.aoa_to_sheet(overviewData);
            XLSX.utils.book_append_sheet(wb, overviewWs, "Overview");
            
            // Create Gigs sheet with expenses
            const gigsData = [
                ['Gig Name', 'Amount (â‚¬)', 'Participants', 'Share Value (â‚¬)', 'Participants Count', 'Associated Expenses (â‚¬)', 'Net Per Share (â‚¬)']
            ];
            
            gigs.forEach(gig => {
                let gigAmount = gig.amount;
                if (socialWelfare && gigs.length > 0) {
                    const averageAmount = gigs.reduce((sum, g) => g.amount + sum, 0) / gigs.length;
                    gigAmount = averageAmount;
                }
                
                const participantShareValue = gigAmount / gig.participants.length;
                
                // Calculate expenses associated with this gig
                let gigExpenses = 0;
                costs.forEach(cost => {
                    if (cost.gigIds && cost.gigIds.includes(gig.id)) {
                        gigExpenses += cost.amount / cost.gigIds.length; // Split expense across associated gigs
                    } else if (cost.gigId === gig.id) {
                        gigExpenses += cost.amount;
                    }
                });
                
                const netPerShare = (gigAmount - gigExpenses) / gig.participants.length;
                
                gigsData.push([
                    gig.name,
                    gigAmount.toFixed(2),
                    gig.participants.join(', '),
                    participantShareValue.toFixed(2),
                    gig.participants.length,
                    gigExpenses.toFixed(2),
                    netPerShare.toFixed(2)
                ]);
            });
            
            const gigsWs = XLSX.utils.aoa_to_sheet(gigsData);
            XLSX.utils.book_append_sheet(wb, gigsWs, "Gigs with Expenses");
            
            // Create Detailed Costs sheet
            const costsData = [
                ['Type', 'Description', 'Amount (â‚¬)', 'Associated Gigs', 'Paid By', 'Used/Consumed By', 'Split Method']
            ];
            
            costs.forEach(cost => {
                let usedBy = 'All members';
                let splitMethod = 'Equal split';
                
                if (cost.type === 'food' && cost.individualCost && cost.consumer) {
                    usedBy = cost.consumer;
                    splitMethod = 'Individual expense';
                } else if (cost.users && cost.users.length > 0) {
                    usedBy = cost.users.join(', ');
                    splitMethod = 'Group expense';
                } else if (cost.beneficiaries && cost.beneficiaries.length > 0) {
                    usedBy = cost.beneficiaries.join(', ');
                    splitMethod = 'Group expense';
                } else if (cost.consumers) {
                    usedBy = cost.consumers.join(', ');
                    splitMethod = 'Group expense';
                } else if (cost.splitEqually) {
                    splitMethod = 'Equal split (travel)';
                }
                
                const associatedGigs = cost.gigNames ? cost.gigNames.join(', ') : (cost.gigName || 'N/A');
                
                costsData.push([
                    cost.type,
                    cost.description,
                    cost.amount.toFixed(2),
                    associatedGigs,
                    cost.payer || 'Individual',
                    usedBy,
                    splitMethod
                ]);
            });
            
            const costsWs = XLSX.utils.aoa_to_sheet(costsData);
            XLSX.utils.book_append_sheet(wb, costsWs, "Detailed Costs");
            
            // Create Detailed Member Breakdown sheet
            const memberBalances = {};
            const memberShares = {};
            const memberExpenses = {};
            
            // Initialize data structures
            members.forEach(member => {
                memberBalances[member] = 0;
                memberShares[member] = 0;
                memberExpenses[member] = 0;
            });
            
            // Calculate shares from gigs
            if (socialWelfare && gigs.length > 0) {
                // In social welfare mode, calculate a universal share value
                const totalIncomeForShares = gigs.reduce((sum, gig) => sum + gig.amount, 0);
                let totalSharesForCalc = 0;
                
                // Count total shares
                gigs.forEach(gig => {
                    totalSharesForCalc += gig.participants.length;
                });
                
                const universalShareValue = totalIncomeForShares / totalSharesForCalc;
                
                // Apply universal share value to each participant
                gigs.forEach(gig => {
                    gig.participants.forEach(participant => {
                        memberBalances[participant] += universalShareValue;
                        memberShares[participant] += universalShareValue;
                    });
                });
            } else {
                // Normal mode - each gig pays its actual amount
                gigs.forEach(gig => {
                    const participantShare = gig.amount / gig.participants.length;
                    gig.participants.forEach(participant => {
                        memberBalances[participant] += participantShare;
                        memberShares[participant] += participantShare;
                    });
                });
            }
            
            // Calculate expenses (same logic as main calculation)
            costs.forEach(cost => {
                if ((cost.type === 'car-travel' || cost.type === 'general-travel' || cost.type === 'parking') && cost.splitEqually) {
                    const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                    const costPerMember = cost.amount / activeMemberCount;
                    
                    members.forEach(member => {
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            memberBalances[member] -= costPerMember;
                            memberExpenses[member] += costPerMember;
                        }
                    });
                    memberBalances[cost.payer] += cost.amount;
                } else if (cost.type === 'car-travel' && cost.users && cost.users.length > 0) {
                    const costPerUser = cost.amount / cost.users.length;
                    cost.users.forEach(user => {
                        memberBalances[user] -= costPerUser;
                        memberExpenses[user] += costPerUser;
                    });
                    memberBalances[cost.payer] += cost.amount;
                } else if ((cost.type === 'general-travel' || cost.type === 'parking') && cost.beneficiaries && cost.beneficiaries.length > 0) {
                    const costPerBeneficiary = cost.amount / cost.beneficiaries.length;
                    cost.beneficiaries.forEach(beneficiary => {
                        memberBalances[beneficiary] -= costPerBeneficiary;
                        memberExpenses[beneficiary] += costPerBeneficiary;
                    });
                    memberBalances[cost.payer] += cost.amount;
                } else if (cost.type === 'food' && cost.individualCost && cost.consumer) {
                    // Food is an individual cost - only the consumer pays
                    memberBalances[cost.consumer] -= cost.amount;
                    memberExpenses[cost.consumer] += cost.amount;
                } else if (cost.type === 'food' && cost.consumers) {
                    // Legacy food cost handling
                    const costPerConsumer = cost.amount / cost.consumers.length;
                    cost.consumers.forEach(consumer => {
                        memberBalances[consumer] -= costPerConsumer;
                        memberExpenses[consumer] += costPerConsumer;
                    });
                    memberBalances[cost.payer] += cost.amount;
                } else {
                    const activeMemberCount = includeBandpotInExpenses ? members.length : members.filter(m => m !== 'Bandpot').length;
                    const costPerMember = cost.amount / activeMemberCount;
                    
                    members.forEach(member => {
                        if (includeBandpotInExpenses || member !== 'Bandpot') {
                            memberBalances[member] -= costPerMember;
                            memberExpenses[member] += costPerMember;
                        }
                    });
                    memberBalances[cost.payer] += cost.amount;
                }
            });
            
            const memberData = [
                ['Member', 'Gig Shares', 'Income (â‚¬)', 'Expenses (â‚¬)', 'Net Balance (â‚¬)', 'Net + BTW (â‚¬)', 'Share Count']
            ];
            
            members.forEach(member => {
                let sharesEarned = 0;
                gigs.forEach(gig => {
                    if (gig.participants.includes(member)) {
                        sharesEarned += 1;
                    }
                });
                
                const income = memberShares[member];
                const expenses = memberExpenses[member];
                const balance = memberBalances[member];
                const balanceWithBTW = balance * 1.09;
                
                memberData.push([
                    member,
                    sharesEarned,
                    income.toFixed(2),
                    expenses.toFixed(2),
                    balance.toFixed(2),
                    balanceWithBTW.toFixed(2),
                    sharesEarned
                ]);
            });
            
            const memberWs = XLSX.utils.aoa_to_sheet(memberData);
            XLSX.utils.book_append_sheet(wb, memberWs, "Member Breakdown");
            
            // Create Cost Categories sheet
            const costsByCategory = {
                'car-travel': 0,
                'general-travel': 0,
                'parking': 0,
                'food': 0,
                'advertisement': 0,
                'other': 0
            };
            
            costs.forEach(cost => {
                if (costsByCategory.hasOwnProperty(cost.type)) {
                    costsByCategory[cost.type] += cost.amount;
                }
            });
            
            const categoryData = [
                ['Category', 'Total Amount (â‚¬)'],
                ['Car Travel', costsByCategory['car-travel'].toFixed(2)],
                ['General Travel', costsByCategory['general-travel'].toFixed(2)],
                ['Parking', costsByCategory['parking'].toFixed(2)],
                ['Food', costsByCategory['food'].toFixed(2)],
                ['Advertisement', costsByCategory['advertisement'].toFixed(2)],
                ['Other', costsByCategory['other'].toFixed(2)],
                [],
                ['TOTAL', totalExpenses.toFixed(2)]
            ];
            
            const categoryWs = XLSX.utils.aoa_to_sheet(categoryData);
            XLSX.utils.book_append_sheet(wb, categoryWs, "Cost Categories");
            
            // Create Individual Food Expenses sheet
            const foodExpensesData = [
                ['Member', 'Gig', 'Description', 'Amount (â‚¬)', 'Date Added']
            ];
            
            costs.forEach(cost => {
                if (cost.type === 'food' && cost.individualCost && cost.consumer) {
                    const gigName = cost.gigName || 'Unknown Gig';
                    foodExpensesData.push([
                        cost.consumer,
                        gigName,
                        cost.description,
                        cost.amount.toFixed(2),
                        new Date(cost.id).toLocaleDateString()
                    ]);
                }
            });
            
            if (foodExpensesData.length > 1) {
                const foodWs = XLSX.utils.aoa_to_sheet(foodExpensesData);
                XLSX.utils.book_append_sheet(wb, foodWs, "Individual Food Expenses");
            }
            
            // Create Gig Profitability Analysis
            const profitabilityData = [
                ['Gig Name', 'Income (â‚¬)', 'Expenses (â‚¬)', 'Net Profit (â‚¬)', 'Profit per Participant (â‚¬)', 'Participants']
            ];
            
            gigs.forEach(gig => {
                let gigAmount = gig.amount;
                if (socialWelfare && gigs.length > 0) {
                    const averageAmount = gigs.reduce((sum, g) => g.amount + sum, 0) / gigs.length;
                    gigAmount = averageAmount;
                }
                
                let gigExpenses = 0;
                costs.forEach(cost => {
                    if (cost.gigIds && cost.gigIds.includes(gig.id)) {
                        gigExpenses += cost.amount / cost.gigIds.length;
                    } else if (cost.gigId === gig.id) {
                        gigExpenses += cost.amount;
                    }
                });
                
                const netProfit = gigAmount - gigExpenses;
                const profitPerParticipant = gig.participants.length > 0 ? netProfit / gig.participants.length : 0;
                
                profitabilityData.push([
                    gig.name,
                    gigAmount.toFixed(2),
                    gigExpenses.toFixed(2),
                    netProfit.toFixed(2),
                    profitPerParticipant.toFixed(2),
                    gig.participants.join(', ')
                ]);
            });
            
            const profitabilityWs = XLSX.utils.aoa_to_sheet(profitabilityData);
            XLSX.utils.book_append_sheet(wb, profitabilityWs, "Gig Profitability");
            
            // Save the file
            XLSX.writeFile(wb, 'spull-band-finances.xlsx');
        }

        // Add event listeners for checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('socialWelfare').addEventListener('change', function() {
                updateSummary();
                saveData();
            });
            
            document.getElementById('splitTravelCosts').addEventListener('change', function() {
                updateSummary();
                saveData();
            });
            
            document.getElementById('includeBandpotInExpenses').addEventListener('change', function() {
                updateSummary();
                saveData();
            });
        });
    </script>
</body>
</html>
